<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge Governance Demo</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM (Development versions for better UMD compatibility) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Lucide React Icons (Latest UMD) -->
    <!-- Note: This exposes the global variable 'lucide' -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.min.js"></script>

    <style>
        /* Custom scrollbar styles */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #000; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 2px;
        }
        
        @keyframes scan {
          0% { top: -20%; opacity: 0; }
          10% { opacity: 1; }
          90% { opacity: 1; }
          100% { top: 120%; opacity: 0; }
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. Imports Replacement (Destructuring from globals) ---
        const { useState, useEffect, useRef } = React;
        
        // FIX: The global variable for lucide-react UMD is 'lucide', not 'lucideReact'
        const { 
            Shield, ShieldAlert, ShieldCheck, Activity, Terminal, Lock, 
            Database, AlertTriangle, UserCog, Hash, Server, FileJson 
        } = lucide;

        // --- 2. Utility Components ---

        const StatusBadge = ({ status }) => {
            const colors = {
                IDLE: "bg-slate-800 text-slate-400 border-slate-700",
                PROCESSING: "bg-blue-900/30 text-blue-400 border-blue-500/50 animate-pulse",
                SUCCESS: "bg-emerald-900/30 text-emerald-400 border-emerald-500/50",
                WARNING: "bg-amber-900/30 text-amber-400 border-amber-500/50",
                ERROR: "bg-red-900/30 text-red-400 border-red-500/50",
            };
            return (
                <span className={`px-2 py-0.5 rounded text-[10px] font-mono border ${colors[status] || colors.IDLE}`}>
                {status}
                </span>
            );
        };

        const TypewriterCode = ({ code, highlightLine, highlightColor }) => {
            return (
                <div className="font-mono text-xs leading-5 p-3 bg-slate-950 rounded border border-slate-800 overflow-hidden relative h-full">
                <div className="absolute top-0 left-0 w-8 h-full bg-slate-900/50 border-r border-slate-800 text-slate-600 flex flex-col items-end pr-2 pt-3 select-none">
                    {code.split('\n').map((_, i) => <div key={i}>{i + 1}</div>)}
                </div>
                <div className="pl-10 pt-0">
                    {code.split('\n').map((line, i) => (
                    <div key={i} className={`px-1 transition-colors duration-300 ${
                        highlightLine === i + 1 
                        ? (highlightColor === 'red' ? 'bg-red-900/40 text-red-200' : 'bg-emerald-900/40 text-emerald-200') 
                        : 'text-slate-300'
                    }`}>
                        {line || ' '}
                    </div>
                    ))}
                </div>
                </div>
            );
        };

        const TerminalOutput = ({ logs }) => {
            const endRef = useRef(null);
            useEffect(() => endRef.current?.scrollIntoView({ behavior: "smooth" }), [logs]);

            return (
                <div className="h-full bg-black font-mono text-xs p-3 overflow-y-auto text-slate-300 custom-scrollbar">
                <div className="text-slate-500 mb-2">root@sentinel-edge:~# tail -f /var/log/execution.log</div>
                {logs.map((log, i) => (
                    <div key={i} className="mb-1 break-words font-mono">
                    <span className="text-slate-600 mr-2">[{log.time}]</span>
                    <span className={`font-bold ${
                        log.type === 'ERR' ? 'text-red-500' : 
                        log.type === 'WARN' ? 'text-amber-500' : 
                        log.type === 'OK' ? 'text-emerald-500' : 'text-blue-400'
                    }`}>{log.type}</span>
                    <span className="ml-2 text-slate-300">{log.text}</span>
                    </div>
                ))}
                <div ref={endRef} className="animate-pulse text-emerald-500">_</div>
                </div>
            );
        };

        // --- 3. Main Application ---

        function App() {
            const [activeScenario, setActiveScenario] = useState(null);
            const [step, setStep] = useState(0); // 0: Idle, 1: Ingest, 2: Policy, 3: Review, 4: Exec
            const [terminalLogs, setTerminalLogs] = useState([]);
            const [highlightRuleLine, setHighlightRuleLine] = useState(null);
            const [showReviewModal, setShowReviewModal] = useState(false);
            const [currentInputCode, setCurrentInputCode] = useState("");
            const [reviewDiff, setReviewDiff] = useState({ original: "", fixed: "" });
            const [executionHash, setExecutionHash] = useState("Waiting...");

            const delay = (ms) => new Promise(res => setTimeout(res, ms));

            const addTermLog = (type, text) => {
                const time = new Date().toISOString().split('T')[1].slice(0, 8);
                setTerminalLogs(prev => [...prev, { time, type, text }]);
            };

            const rulePackCode = `{
  "policy_id": "EDGE_SEC_v4",
  "rules": [
    { 
      "action": "READ_METRICS", 
      "effect": "ALLOW" 
    },
    { 
      "action": "SQL_QUERY", 
      "condition": "no_limit", 
      "effect": "FLAG_REVIEW" 
    },
    { 
      "action": "DROP_TABLE", 
      "effect": "DENY", 
      "alert": "CRITICAL" 
    }
  ]
}`;

            const reset = () => {
                setStep(0);
                setActiveScenario(null);
                setHighlightRuleLine(null);
                setShowReviewModal(false);
                setCurrentInputCode("");
                setExecutionHash("Waiting...");
            };

            const runScenario1 = async () => {
                if (activeScenario) return;
                reset();
                setActiveScenario(1);
                setTerminalLogs([]);
                
                setStep(1);
                setCurrentInputCode(`POST /api/metrics
Host: edge-node-01
Content-Type: application/json

{
  "intent": "READ_METRICS",
  "target": "sys_cpu_load"
}`);
                addTermLog("INFO", "Receiving packet from 192.168.1.105");
                await delay(800);
                addTermLog("INFO", "Payload signature verified: SHA-256 ok");
                await delay(600);

                setStep(2);
                addTermLog("SYS", "Loading RulePack v4...");
                await delay(500);
                setHighlightRuleLine(5); 
                addTermLog("OK", "MATCH FOUND: Rule #1 (ALLOW)");
                await delay(1000);

                setStep(4); 
                addTermLog("EXEC", "Spawning worker thread...");
                addTermLog("EXEC", "Reading CPU metrics from /proc/stat");
                await delay(800);
                addTermLog("OK", "Response sent: 200 OK (14ms)");
                setExecutionHash("0x7f8a...29c (Immutable)");
                addTermLog("AUDIT", "TxHash: 0x7f8a... logged to ledger");
                
                await delay(3000);
                reset();
            };

            const runScenario2 = async () => {
                if (activeScenario) return;
                reset();
                setActiveScenario(2);
                setTerminalLogs([]);

                setStep(1);
                setCurrentInputCode(`POST /api/db/query
{
  "intent": "SQL_QUERY",
  "query": "SELECT * FROM users",
  "limit": null
}`);
                addTermLog("INFO", "Receiving SQL payload");
                await delay(800);

                setStep(2);
                addTermLog("SYS", "Analyzing SQL syntax complexity...");
                await delay(600);
                setHighlightRuleLine(10);
                addTermLog("WARN", "VIOLATION DETECTED: Unbounded query scan");
                addTermLog("WARN", "Triggering Human-in-the-Loop workflow...");
                await delay(1000);

                setStep(3);
                setReviewDiff({
                    original: "SELECT * FROM users",
                    fixed: "SELECT * FROM users LIMIT 100"
                });
                setShowReviewModal(true);
                addTermLog("WAIT", "Awaiting operator approval...");
                
                await new Promise(resolve => {
                    setTimeout(resolve, 2500);
                });
                
                setShowReviewModal(false);
                setCurrentInputCode(`POST /api/db/query
{
  "intent": "SQL_QUERY",
  "query": "SELECT * FROM users LIMIT 100",
  "approver": "admin_u1"
}`);
                addTermLog("OK", "Operator approved modification.");
                addTermLog("INFO", "Re-submitting corrected payload...");
                
                await delay(800);
                setStep(2); 
                setHighlightRuleLine(5);
                addTermLog("OK", "Policy Re-evaluation: PASSED");
                await delay(600);

                setStep(4);
                addTermLog("EXEC", "Executing SQL: SELECT * FROM users LIMIT 100");
                addTermLog("OK", "Query returned 100 rows. (42ms)");
                setExecutionHash("0x9b2c...88a (Immutable)");
                addTermLog("AUDIT", "ChangeLog recorded: 0x9b2c...");
                
                await delay(3000);
                reset();
            };

            const runScenario3 = async () => {
                if (activeScenario) return;
                reset();
                setActiveScenario(3);
                setTerminalLogs([]);

                setStep(1);
                setCurrentInputCode(`POST /api/admin/exec
{
  "intent": "DROP_TABLE",
  "target": "prod_db",
  "force": true
}`);
                addTermLog("WARN", "High privilege command detected");
                await delay(800);

                setStep(2);
                addTermLog("SYS", "Deep scanning payload...");
                await delay(600);
                setHighlightRuleLine(14); 
                addTermLog("ERR", "CRITICAL BLOCK: Rule #3 (DENY)");
                addTermLog("ERR", "Action 'DROP_TABLE' is blacklisted.");
                await delay(1000);

                setStep(4);
                addTermLog("SEC", "Terminating connection.");
                addTermLog("SEC", "IP 192.168.1.55 added to temporary ban list.");
                setExecutionHash("BLOCKED_EVENT_ID_992");
                addTermLog("AUDIT", "Incident Report #992 generated.");
                
                await delay(3000);
                reset();
            };

            return (
                <div className="min-h-screen p-4 flex flex-col gap-4 overflow-hidden selection:bg-blue-500/30">
                    
                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between items-center bg-slate-900 border border-slate-800 p-4 rounded-xl shadow-lg z-20 sticky top-0">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center shadow-blue-500/20 shadow-lg">
                                <Shield className="text-white w-6 h-6" />
                            </div>
                            <div>
                                <h1 className="text-lg font-bold text-slate-100 tracking-wide">Governance Engine <span className="text-blue-500">Live Demo</span></h1>
                                <div className="flex items-center gap-2 text-xs text-slate-500 font-mono">
                                    <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                                    SYSTEM ONLINE | NODE: EDGE_01
                                </div>
                            </div>
                        </div>

                        <div className="flex gap-3 mt-4 md:mt-0">
                            <button onClick={runScenario1} disabled={activeScenario}
                                className="px-4 py-2 bg-slate-800 hover:bg-emerald-900/20 border border-slate-700 hover:border-emerald-500/50 rounded-lg text-sm font-medium transition-all disabled:opacity-30 disabled:cursor-not-allowed flex items-center gap-2 group text-white">
                                <div className="w-2 h-2 bg-emerald-500 rounded-full group-hover:shadow-[0_0_8px_rgba(16,185,129,0.5)]"></div> 
                                Scenario 1: Normal
                            </button>
                            <button onClick={runScenario2} disabled={activeScenario}
                                className="px-4 py-2 bg-slate-800 hover:bg-amber-900/20 border border-slate-700 hover:border-amber-500/50 rounded-lg text-sm font-medium transition-all disabled:opacity-30 disabled:cursor-not-allowed flex items-center gap-2 group text-white">
                                <div className="w-2 h-2 bg-amber-500 rounded-full group-hover:shadow-[0_0_8px_rgba(245,158,11,0.5)]"></div> 
                                Scenario 2: Human Loop
                            </button>
                            <button onClick={runScenario3} disabled={activeScenario}
                                className="px-4 py-2 bg-slate-800 hover:bg-red-900/20 border border-slate-700 hover:border-red-500/50 rounded-lg text-sm font-medium transition-all disabled:opacity-30 disabled:cursor-not-allowed flex items-center gap-2 group text-white">
                                <div className="w-2 h-2 bg-red-500 rounded-full group-hover:shadow-[0_0_8px_rgba(239,68,68,0.5)]"></div> 
                                Scenario 3: Injection
                            </button>
                        </div>
                    </div>

                    {/* Stage */}
                    <div className="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-4 relative min-h-[600px]">
                        
                        {/* Modal */}
                        {showReviewModal && (
                            <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm animate-in fade-in duration-300">
                                <div className="bg-slate-900 border border-amber-500/50 rounded-xl shadow-2xl w-[90%] max-w-lg overflow-hidden transform scale-100 transition-all">
                                    <div className="bg-amber-950/30 p-4 border-b border-amber-900/50 flex justify-between items-center">
                                        <div className="flex items-center gap-2 text-amber-500 font-bold">
                                            <UserCog className="w-5 h-5" /> Human Intervention Required
                                        </div>
                                        <div className="text-xs bg-amber-900/50 text-amber-200 px-2 py-1 rounded font-mono border border-amber-500/30">POLICY_FLAG_02</div>
                                    </div>
                                    <div className="p-6 space-y-4">
                                        <div>
                                            <div className="text-xs text-slate-500 mb-1 uppercase font-bold tracking-wider">Incoming Violation (Unsafe):</div>
                                            <div className="bg-red-950/20 border border-red-900/30 p-3 rounded text-red-300 font-mono text-sm relative overflow-hidden">
                                                <div className="absolute inset-0 bg-red-500/5 opacity-0 hover:opacity-100 transition-opacity"></div>
                                                <span className="line-through decoration-red-500/50">{reviewDiff.original}</span>
                                            </div>
                                        </div>
                                        <div className="flex justify-center">
                                            <div className="bg-slate-800 p-1.5 rounded-full border border-slate-700"><Server className="w-4 h-4 text-slate-500" /></div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-emerald-500 mb-1 uppercase font-bold tracking-wider">Suggested Fix (Safe):</div>
                                            <div className="bg-emerald-950/20 border border-emerald-900/30 p-3 rounded text-emerald-300 font-mono text-sm shadow-[0_0_15px_rgba(16,185,129,0.1)]">
                                                {reviewDiff.fixed}
                                            </div>
                                        </div>
                                        <div className="pt-4 flex justify-end gap-2 border-t border-slate-800 mt-4">
                                            <div className="text-xs text-slate-500 flex items-center mr-auto">
                                                <Activity className="w-3 h-3 mr-1 animate-pulse" /> Auto-approving in 2s...
                                            </div>
                                            <button className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold rounded shadow-lg shadow-emerald-900/20 transition-all">
                                                Approve Fix
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Col 1 */}
                        <div className={`lg:col-span-4 rounded-xl border flex flex-col transition-all duration-500 relative z-10 ${
                            step === 1 ? 'border-blue-500 shadow-[0_0_20px_rgba(59,130,246,0.2)] bg-slate-900 scale-[1.01]' : 'border-slate-800 bg-slate-900/50 opacity-60 grayscale-[0.5]'
                        }`}>
                            <div className="p-3 border-b border-slate-800 flex justify-between items-center bg-slate-950/50 backdrop-blur-sm rounded-t-xl">
                                <h3 className="text-sm font-semibold text-slate-300 flex items-center gap-2">
                                    <FileJson className="w-4 h-4 text-blue-400" />
                                    Payload Ingest
                                </h3>
                                <StatusBadge status={step === 1 ? "PROCESSING" : "IDLE"} />
                            </div>
                            <div className="flex-1 p-4 flex flex-col h-64 lg:h-auto">
                                {currentInputCode ? (
                                    <TypewriterCode code={currentInputCode} />
                                ) : (
                                    <div className="flex-1 flex flex-col items-center justify-center text-slate-600 text-sm italic border-2 border-dashed border-slate-800 rounded-lg">
                                        <Activity className="w-8 h-8 mb-2 opacity-20" />
                                        Awaiting Agent Stream...
                                    </div>
                                )}
                                {step === 1 && (
                                    <div className="mt-4 flex items-center gap-2 text-xs text-blue-400 animate-pulse font-mono">
                                        <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        Verifying Signature (TLS 1.3)...
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Col 2 */}
                        <div className={`lg:col-span-4 rounded-xl border flex flex-col transition-all duration-500 relative z-10 ${
                            step === 2 || step === 3 ? 'border-indigo-500 shadow-[0_0_30px_rgba(99,102,241,0.15)] bg-slate-900 scale-[1.01]' : 'border-slate-800 bg-slate-900/50 opacity-60 grayscale-[0.5]'
                        }`}>
                            <div className="p-3 border-b border-slate-800 flex justify-between items-center bg-slate-950/50 backdrop-blur-sm rounded-t-xl">
                                <h3 className="text-sm font-semibold text-slate-300 flex items-center gap-2">
                                    <ShieldCheck className="w-4 h-4 text-indigo-400" />
                                    RulePack Engine v3.2
                                </h3>
                                <StatusBadge status={step === 2 ? "PROCESSING" : step === 3 ? "WARNING" : "IDLE"} />
                            </div>
                            <div className="flex-1 p-4 overflow-hidden relative h-64 lg:h-auto">
                                <TypewriterCode 
                                    code={rulePackCode} 
                                    highlightLine={highlightRuleLine}
                                    highlightColor={activeScenario === 3 ? 'red' : 'green'}
                                />
                                {step === 2 && (
                                    <div className="absolute inset-0 pointer-events-none bg-gradient-to-b from-transparent via-indigo-500/10 to-transparent h-[20%] w-full animate-[scan_1.5s_linear_infinite]"></div>
                                )}
                            </div>
                        </div>

                        {/* Col 3 */}
                        <div className={`lg:col-span-4 rounded-xl border flex flex-col transition-all duration-500 overflow-hidden relative z-10 ${
                            step === 4 ? 'border-emerald-500 shadow-[0_0_30px_rgba(16,185,129,0.15)] bg-slate-900 scale-[1.01]' : 'border-slate-800 bg-slate-900/50 opacity-60 grayscale-[0.5]'
                        }`}>
                            <div className="p-3 border-b border-slate-800 flex justify-between items-center bg-slate-950/50 backdrop-blur-sm rounded-t-xl">
                                <h3 className="text-sm font-semibold text-slate-300 flex items-center gap-2">
                                    <Terminal className="w-4 h-4 text-emerald-400" />
                                    Live Execution Log
                                </h3>
                                <StatusBadge status={step === 4 ? (activeScenario === 3 ? "ERROR" : "SUCCESS") : "IDLE"} />
                            </div>
                            <div className="flex-1 bg-black h-64 lg:h-auto border-x border-slate-800">
                                <TerminalOutput logs={terminalLogs} />
                            </div>
                            <div className="p-2 bg-slate-950 border-t border-slate-800 flex items-center gap-2 text-[10px] text-slate-500 font-mono">
                                <Hash className="w-3 h-3 text-slate-600" />
                                <span className={`truncate transition-colors duration-500 ${step === 4 ? 'text-emerald-500' : ''}`}>
                                    {executionHash}
                                </span>
                                {step === 4 && <Lock className="w-3 h-3 text-emerald-500 ml-auto" />}
                            </div>
                        </div>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
